name: Execute Managed Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  execute-pipeline:
    runs-on: [flutter-stable,java-8,java-11,java-17,java-21,ubuntu-latest]  # åŒ¹é…æ‚¨çš„è‡ªå»ºå¤šæ ‡ç­¾ Runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ”¯æŒå®Œæ•´å†å²æŸ¥è¯¢ï¼ˆå¦‚ç‰ˆæœ¬è®¡ç®—ï¼‰

      - name: Prepare & Execute Pipeline
        env:
          # åŸºç¡€ Gitea ç¯å¢ƒå˜é‡ï¼ˆè„šæœ¬ä¸­å¯ç›´æ¥ä½¿ç”¨ï¼‰
          GITEA_TOKEN: ${{ gitea.token }}
          GITEA_REPO: ${{ gitea.repository }}
          GITEA_REPO_OWNER: ${{ gitea.repository_owner }}
          GITEA_API_URL: ${{ gitea.api_url }}
          GITEA_RUN_NUMBER: ${{ gitea.run_number }}
          # è‡ªå®šä¹‰æ‰©å±•å˜é‡ï¼ˆç¤ºä¾‹ï¼Œå¯è‡ªè¡Œæ·»åŠ ï¼‰
          NTFY_BASE_URL: "http://192.168.0.169:8125"
          NTFY_TOPIC: "169"

        run: |
          echo "ğŸ åˆå§‹åŒ– Python ç¯å¢ƒä¸ä¾èµ–..."

          # --- å‡çº§ pipï¼ˆæ¨èï¼‰ ---
          python3 -m pip install --upgrade pip -q

          # --- æ­¥éª¤1ï¼šå®‰è£… .ci/requirements.txtï¼ˆå¦‚æœå­˜åœ¨ï¼‰ ---
          REQ_FILE=".ci/requirements.txt"
          if [ -f "$REQ_FILE" ]; then
            echo "ğŸ“¦ å‘ç° requirements.txtï¼Œæ­£åœ¨å®‰è£…é¡¹ç›®è‡ªå®šä¹‰ä¾èµ–..."
            python3 -m pip install -r "$REQ_FILE" -q --break-system-packages || true
          else
            echo "âš ï¸ æœªæ‰¾åˆ° .ci/requirements.txtï¼Œè·³è¿‡é¡¹ç›®ä¾èµ–å®‰è£…"
          fi

          # --- æ­¥éª¤2ï¼šå®‰è£…é¢å¤–å›ºå®šä¾èµ–ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰ ---
          EXTRA_PACKAGES="requests semver"  # å¯åœ¨æ­¤ç›´æ¥æ·»åŠ /åˆ é™¤å¸¸ç”¨åŒ…
          if [ -n "$EXTRA_PACKAGES" ]; then
            echo "ğŸ“¦ å®‰è£…é¢å¤–å›ºå®šä¾èµ–: $EXTRA_PACKAGES"
            python3 -m pip install $EXTRA_PACKAGES -q --break-system-packages || true
          fi

          # --- ä»»åŠ¡æ¸…å•ç¼–æ’ï¼ˆé¡ºåºè‡ªç”±è°ƒæ•´ï¼‰ ---
          PIPELINE_STEPS=(
            ".ci/check.py"         # ä»£ç æ£€æŸ¥
            ".ci/safe.py"          # å®‰å…¨/æ¼æ´æ‰«æ
            ".ci/performance.py"   # æ€§èƒ½æµ‹è¯•
            ".ci/deploy.py"        # éƒ¨ç½²
          )

          # --- å¾ªç¯é¡ºåºæ‰§è¡Œ ---
          echo "ğŸš€ å¼€å§‹æŒ‰åºæ‰§è¡Œè„šæœ¬æ¸…å•..."
          for script in "${PIPELINE_STEPS[@]}"; do
            if [ -f "$script" ]; then
              echo "------------------------------------------"
              echo "â–¶ï¸ æ­£åœ¨è¿è¡Œ: $script"
              python3 "$script" || { echo "âŒ å¤±è´¥: $script" ; exit 1; }
            else
              echo "------------------------------------------"
              echo "â­ï¸ è·³è¿‡ä¸å­˜åœ¨çš„è„šæœ¬: $script"
            fi
          done

          echo "------------------------------------------"
          echo "âœ¨ æ­å–œï¼æ‰€æœ‰æµç¨‹å·²åœ†æ»¡å®Œæˆã€‚"